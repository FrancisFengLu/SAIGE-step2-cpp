<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAIGE Step 2: Complete Branching Flowchart</title>

<!-- KaTeX CDN for math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false}
    ],
    throwOnError: false
  });"></script>

<style>
:root {
  --color-blue: #3498db;
  --color-green: #27ae60;
  --color-red: #e74c3c;
  --color-purple: #8e44ad;
  --color-orange: #f39c12;
  --color-teal: #16a085;
  --color-dark: #2c3e50;
  --color-gray: #7f8c8d;
  --sidebar-width: 240px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.7;
  color: #333;
  background: #ffffff;
}

/* Sidebar */
#sidebar {
  position: fixed;
  top: 0; left: 0;
  width: var(--sidebar-width);
  height: 100vh;
  background: #1a1a2e;
  color: #c8c8e0;
  overflow-y: auto;
  z-index: 1000;
  padding: 20px 0;
  border-right: 3px solid #e94560;
}

#sidebar h2 {
  color: #fff;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 0 18px 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 10px;
}

#sidebar nav a {
  display: block;
  color: #c8c8e0;
  text-decoration: none;
  padding: 7px 18px;
  font-size: 12.5px;
  transition: all 0.2s ease;
  border-left: 3px solid transparent;
}

#sidebar nav a:hover {
  background: rgba(255,255,255,0.05);
  color: #fff;
}

#sidebar nav a.sub {
  padding-left: 32px;
  font-size: 11.5px;
}

#sidebar nav a.active {
  background: rgba(233,69,96,0.2);
  color: #fff;
  border-left: 3px solid #e94560;
  font-weight: bold;
}

/* Content */
#content {
  margin-left: var(--sidebar-width);
  padding: 30px 40px;
  max-width: 1700px;
}

h1 {
  font-size: 2em;
  color: var(--color-dark);
  border-bottom: 3px solid #e94560;
  padding-bottom: 12px;
  margin-bottom: 20px;
}

h2 {
  font-size: 1.5em;
  color: var(--color-dark);
  margin-top: 40px;
  margin-bottom: 15px;
  padding-top: 12px;
  border-top: 2px solid #e0e0e0;
}

h2:first-of-type { border-top: none; margin-top: 15px; }

p { margin-bottom: 12px; font-size: 14px; }

h3 {
  font-size: 1.15em;
  color: #555;
  margin-top: 25px;
  margin-bottom: 8px;
}

section { scroll-margin-top: 20px; }

.legend {
  display: flex;
  gap: 20px;
  margin: 12px 0 20px;
  padding: 10px 16px;
  background: #f0f0f0;
  border-radius: 6px;
  font-size: 13px;
  flex-wrap: wrap;
}

.legend span {
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.legend .dot {
  width: 14px; height: 14px;
  border-radius: 3px;
  display: inline-block;
}

.pipeline-container {
  width: 100%;
  overflow-x: auto;
  margin: 15px 0 25px;
}

.pipeline-container svg {
  display: block;
  margin: 0 auto;
}

.note {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-left: 4px solid #ffc107;
  padding: 10px 14px;
  border-radius: 0 6px 6px 0;
  margin: 12px 0;
  font-size: 13px;
}

.note strong { color: #856404; }

@media (max-width: 1000px) {
  #sidebar { display: none; }
  #content { margin-left: 0; padding: 20px; }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <h2>Branching Flowchart</h2>
  <nav>
    <a href="#sec-overview">Overview</a>
    <a href="#sec-part1">Part 1: Main Entry</a>
    <a href="#sec-part2">Part 2: Single-Variant</a>
    <a class="sub" href="#sec-part2a">2a. Score Test Selection</a>
    <a class="sub" href="#sec-part2b">2b. SPA / ER / Normal</a>
    <a class="sub" href="#sec-part2c">2c. Firth & Re-eval</a>
    <a href="#sec-part3">Part 3: Region/Gene</a>
    <a class="sub" href="#sec-part3a">3a. Marker Classification</a>
    <a class="sub" href="#sec-part3b">3b. BURDEN/SKAT/SKAT-O</a>
    <a class="sub" href="#sec-part3c">3c. Davies vs Liu</a>
    <a href="#sec-part4">Part 4: SPA Detail</a>
    <a href="#sec-part5">Part 5: VR Assignment</a>
    <a href="#sec-part6">Part 6: CCT</a>
  </nav>
</div>

<!-- CONTENT -->
<div id="content">

<!-- ============================================================ -->
<!-- OVERVIEW -->
<!-- ============================================================ -->
<section id="sec-overview">
<h1>SAIGE Step 2 &mdash; Complete Branching Flowchart</h1>

<p>
This document shows <strong>every branching decision</strong> in the SAIGE Step 2 C++ standalone code
as visual flowcharts. All formulas use mathematical notation (not code).
</p>

<div class="legend">
  <span><span class="dot" style="background:#3498db"></span> Standard flow</span>
  <span><span class="dot" style="background:#e74c3c"></span> Binary-trait only</span>
  <span><span class="dot" style="background:#27ae60"></span> Output / result</span>
  <span><span class="dot" style="background:#8e44ad"></span> Region-test specific</span>
  <span><span class="dot" style="background:#f39c12"></span> Decision point</span>
  <span><span class="dot" style="background:#16a085"></span> Optional path</span>
</div>
</section>

<!-- ============================================================ -->
<!-- PART 1: MAIN ENTRY -->
<!-- ============================================================ -->
<section id="sec-part1">
<h2>Part 1: Main Entry &mdash; Top-Level Decision</h2>

<p>The program loads all inputs, then takes one of two major paths: single-variant testing or region/gene-based testing.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1600 520" width="1580" height="510" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1600" height="520" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a1" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a1r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a1b" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#3498db"/></marker>
    <marker id="a1p" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#8e44ad"/></marker>
    <marker id="a1g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
  </defs>

  <!-- Title -->
  <text x="800" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#2c3e50">SAIGE Step 2 &mdash; Top-Level Flow</text>

  <!-- Row 1: Inputs -->
  <rect x="30" y="55" width="200" height="55" rx="8" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
  <text x="130" y="78" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Null Model</text>
  <text x="130" y="96" text-anchor="middle" fill="#d5e8f7" font-size="10">(JSON + .arma files from Step 1)</text>

  <rect x="260" y="55" width="200" height="55" rx="8" fill="#27ae60" stroke="#219a52" stroke-width="2"/>
  <text x="360" y="78" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Genotype File</text>
  <text x="360" y="96" text-anchor="middle" fill="#c8f0d4" font-size="10">PLINK / VCF / BGEN / PGEN</text>

  <rect x="490" y="55" width="200" height="55" rx="8" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
  <text x="590" y="78" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Variance Ratios</text>
  <text x="590" y="96" text-anchor="middle" fill="#f5c6cb" font-size="10">MAC category bins</text>

  <rect x="720" y="55" width="200" height="55" rx="8" fill="#8e44ad" stroke="#7d3c98" stroke-width="2"/>
  <text x="820" y="78" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Group File</text>
  <text x="820" y="96" text-anchor="middle" fill="#dcc6e8" font-size="10">(region test only)</text>

  <rect x="950" y="55" width="200" height="55" rx="8" fill="#16a085" stroke="#1abc9c" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="1050" y="78" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Condition Markers</text>
  <text x="1050" y="96" text-anchor="middle" fill="#a3e4d7" font-size="10">(optional: rs1, rs2, ...)</text>

  <!-- Arrows to SAIGEClass -->
  <line x1="130" y1="110" x2="130" y2="140" stroke="#555" stroke-width="2"/>
  <line x1="360" y1="110" x2="360" y2="140" stroke="#555" stroke-width="2"/>
  <line x1="590" y1="110" x2="500" y2="140" stroke="#555" stroke-width="1.5"/>
  <line x1="130" y1="140" x2="500" y2="140" stroke="#555" stroke-width="2"/>
  <line x1="500" y1="140" x2="500" y2="155" stroke="#555" stroke-width="2" marker-end="url(#a1)"/>

  <!-- SAIGEClass init -->
  <rect x="310" y="155" width="380" height="50" rx="8" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
  <text x="500" y="176" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Initialize SAIGEClass</text>
  <text x="500" y="194" text-anchor="middle" fill="#b0bec5" font-size="11">Load all null model parameters + VR + sparse GRM</text>

  <!-- Arrow down to main decision -->
  <line x1="500" y1="205" x2="500" y2="240" stroke="#555" stroke-width="2" marker-end="url(#a1)"/>

  <!-- Main decision diamond -->
  <polygon points="500,240 650,280 500,320 350,280" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="500" y="278" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Region test?</text>

  <!-- LEFT: Single-variant path -->
  <line x1="350" y1="280" x2="200" y2="280" stroke="#3498db" stroke-width="2.5"/>
  <line x1="200" y1="280" x2="200" y2="330" stroke="#3498db" stroke-width="2.5" marker-end="url(#a1b)"/>
  <text x="275" y="270" font-size="11" fill="#3498db" font-weight="bold">NO</text>

  <rect x="70" y="330" width="260" height="50" rx="8" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
  <text x="200" y="352" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Single-Variant Testing</text>
  <text x="200" y="370" text-anchor="middle" fill="#d5e8f7" font-size="10">For each marker: score test + SPA/ER</text>

  <!-- Sub-steps of single-variant -->
  <line x1="200" y1="380" x2="200" y2="410" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="80" y="410" width="240" height="40" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="200" y="434" text-anchor="middle" font-size="11" fill="#333">For each marker: read genotype G</text>

  <line x1="200" y1="450" x2="200" y2="470" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="70" y="470" width="260" height="35" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="200" y="492" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Output: single-variant results</text>

  <!-- RIGHT: Region path -->
  <line x1="650" y1="280" x2="850" y2="280" stroke="#8e44ad" stroke-width="2.5"/>
  <line x1="850" y1="280" x2="850" y2="330" stroke="#8e44ad" stroke-width="2.5" marker-end="url(#a1p)"/>
  <text x="740" y="270" font-size="11" fill="#8e44ad" font-weight="bold">YES</text>

  <rect x="700" y="330" width="300" height="50" rx="8" fill="#8e44ad" stroke="#7d3c98" stroke-width="2"/>
  <text x="850" y="352" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Region / Gene-Based Testing</text>
  <text x="850" y="370" text-anchor="middle" fill="#dcc6e8" font-size="10">For each gene: collect markers, run BURDEN/SKAT/SKAT-O</text>

  <!-- Sub-outputs of region -->
  <line x1="770" y1="380" x2="720" y2="415" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="850" y1="380" x2="850" y2="415" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>
  <line x1="930" y1="380" x2="980" y2="415" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>

  <rect x="650" y="415" width="110" height="35" rx="6" fill="#2ecc71" stroke="#27ae60"/>
  <text x="705" y="437" text-anchor="middle" fill="white" font-size="11" font-weight="bold">BURDEN</text>

  <rect x="795" y="415" width="110" height="35" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="850" y="437" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SKAT</text>

  <rect x="940" y="415" width="110" height="35" rx="6" fill="#9b59b6" stroke="#8e44ad"/>
  <text x="995" y="437" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SKAT-O</text>

  <!-- CCT -->
  <line x1="705" y1="450" x2="705" y2="468" stroke="#555" stroke-width="1"/>
  <line x1="850" y1="450" x2="850" y2="468" stroke="#555" stroke-width="1"/>
  <line x1="995" y1="450" x2="995" y2="468" stroke="#555" stroke-width="1"/>
  <line x1="705" y1="468" x2="995" y2="468" stroke="#555" stroke-width="1.5"/>
  <line x1="850" y1="468" x2="850" y2="485" stroke="#555" stroke-width="1.5" marker-end="url(#a1)"/>
  <rect x="780" y="485" width="140" height="30" rx="6" fill="#e67e22" stroke="#d35400"/>
  <text x="850" y="504" text-anchor="middle" fill="white" font-size="11" font-weight="bold">CCT Combination</text>

  <!-- LD Matrix optional -->
  <rect x="1200" y="330" width="160" height="45" rx="8" fill="#7f8c8d" stroke="#6c7a89" stroke-dasharray="5,3"/>
  <text x="1280" y="350" text-anchor="middle" fill="white" font-size="11" font-weight="bold">LD Matrix Output</text>
  <text x="1280" y="366" text-anchor="middle" fill="#d5d8dc" font-size="9">(optional side path)</text>
  <line x1="1000" y1="345" x2="1200" y2="352" stroke="#7f8c8d" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#a1)"/>

  <!-- Conditional analysis note -->
  <line x1="1050" y1="110" x2="1050" y2="145" stroke="#16a085" stroke-width="1.5" stroke-dasharray="5,3"/>
  <line x1="1050" y1="145" x2="500" y2="145" stroke="#16a085" stroke-width="1" stroke-dasharray="4,3"/>
  <text x="1200" y="142" font-size="9" fill="#16a085">feeds into SAIGEClass</text>
</svg>
</div>

</section>


<!-- ============================================================ -->
<!-- PART 2: SINGLE-VARIANT PATH -->
<!-- ============================================================ -->
<section id="sec-part2">
<h2>Part 2: Single-Variant Path (Per-Marker Decision Tree)</h2>

<p>This is the complete decision tree for each marker in single-variant testing. All 5 critical decision points are shown.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1700 1700" width="1680" height="1690" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1700" height="1700" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a2r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a2b" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#3498db"/></marker>
    <marker id="a2g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
    <marker id="a2o" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e67e22"/></marker>
    <marker id="a2p" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#8e44ad"/></marker>
  </defs>

  <!-- Title -->
  <text x="850" y="28" text-anchor="middle" font-size="18" font-weight="bold" fill="#2c3e50">Single-Variant Testing &mdash; Complete Decision Tree</text>

  <!-- START: read genotype -->
  <rect x="700" y="48" width="300" height="40" rx="20" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
  <text x="850" y="73" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Read genotype vector G for marker</text>

  <line x1="850" y1="88" x2="850" y2="115" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- QC Filter diamond -->
  <polygon points="850,115 1010,155 850,195 690,155" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="150" text-anchor="middle" fill="white" font-size="11" font-weight="bold">QC: MAC, missing rate,</text>
  <text x="850" y="164" text-anchor="middle" fill="white" font-size="11" font-weight="bold">MAF within range?</text>

  <!-- FAIL: skip marker -->
  <line x1="1010" y1="155" x2="1130" y2="155" stroke="#e74c3c" stroke-width="2" marker-end="url(#a2r)"/>
  <text x="1060" y="147" font-size="10" fill="#e74c3c" font-weight="bold">FAIL</text>
  <rect x="1130" y="140" width="130" height="30" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="1195" y="160" text-anchor="middle" font-size="11" fill="#7f8c8d">Skip marker</text>

  <!-- PASS -->
  <line x1="850" y1="195" x2="850" y2="225" stroke="#27ae60" stroke-width="2" marker-end="url(#a2g)"/>
  <text x="870" y="215" font-size="10" fill="#27ae60" font-weight="bold">PASS</text>

  <!-- Impute & flip -->
  <rect x="710" y="225" width="280" height="36" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="850" y="248" text-anchor="middle" font-size="11" fill="#333">Impute missing values, flip if ALT freq > 0.5</text>

  <line x1="850" y1="261" x2="850" y2="290" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- Assign VR -->
  <rect x="700" y="290" width="300" height="36" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="850" y="313" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Assign variance ratio (VR) based on MAC bin</text>

  <line x1="850" y1="326" x2="850" y2="360" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- ======= DECISION POINT 1: Score Test Path ======= -->
  <text x="850" y="355" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 1</text>

  <!-- isFastTest diamond -->
  <polygon points="850,370 1020,405 850,440 680,405" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="403" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Fast test mode?</text>

  <!-- YES: set sparse=false for initial test -->
  <line x1="850" y1="440" x2="850" y2="460" stroke="#555" stroke-width="1.5" marker-end="url(#a2)"/>
  <text x="870" y="455" font-size="9" fill="#27ae60">YES: sparse=false (initial)</text>

  <!-- NO: use model's sparse flag -->
  <line x1="680" y1="405" x2="570" y2="405" stroke="#555" stroke-width="1.5"/>
  <line x1="570" y1="405" x2="570" y2="460" stroke="#555" stroke-width="1.5" marker-end="url(#a2)"/>
  <text x="610" y="397" font-size="9" fill="#555">NO: use model sparse flag</text>

  <!-- Both merge at the 3-way score test selector -->
  <line x1="570" y1="460" x2="850" y2="480" stroke="#555" stroke-width="1" stroke-dasharray="3,3"/>

  <!-- 3-way score test decision -->
  <polygon points="850,480 1050,520 850,560 650,520" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="515" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Which score test path?</text>
  <text x="850" y="530" text-anchor="middle" fill="white" font-size="9">sparse GRM? / no-adj-cov? / standard?</text>

  <!-- Path A: noadjCov (left) -->
  <line x1="650" y1="520" x2="270" y2="520" stroke="#27ae60" stroke-width="2"/>
  <line x1="270" y1="520" x2="270" y2="565" stroke="#27ae60" stroke-width="2" marker-end="url(#a2g)"/>
  <text x="420" y="512" font-size="10" fill="#27ae60" font-weight="bold">no sparse AND noadjCov</text>
  <rect x="140" y="565" width="260" height="55" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="270" y="585" text-anchor="middle" fill="white" font-size="12" font-weight="bold">scoreTestFast_noadjCov</text>
  <text x="270" y="605" text-anchor="middle" fill="#c8f0d4" font-size="10">S = G&#x1D40; r, Var(S) = VR &#xB7; Var&#x2080;</text>

  <!-- Path B: sparseGRM (right) -->
  <line x1="1050" y1="520" x2="1380" y2="520" stroke="#e74c3c" stroke-width="2"/>
  <line x1="1380" y1="520" x2="1380" y2="565" stroke="#e74c3c" stroke-width="2" marker-end="url(#a2r)"/>
  <text x="1200" y="512" font-size="10" fill="#e74c3c" font-weight="bold">sparse GRM active</text>
  <rect x="1250" y="565" width="260" height="55" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1380" y="585" text-anchor="middle" fill="white" font-size="12" font-weight="bold">scoreTest (PCG solver)</text>
  <text x="1380" y="605" text-anchor="middle" fill="#f5c6cb" font-size="10">PG via conjugate gradient with &#x3A3;</text>

  <!-- Path C: standard (center) -->
  <line x1="850" y1="560" x2="850" y2="565" stroke="#3498db" stroke-width="2" marker-end="url(#a2b)"/>
  <text x="875" y="558" font-size="10" fill="#3498db" font-weight="bold">default</text>
  <rect x="700" y="565" width="300" height="55" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="850" y="585" text-anchor="middle" fill="white" font-size="12" font-weight="bold">scoreTestFast (standard)</text>
  <text x="850" y="605" text-anchor="middle" fill="#d5e8f7" font-size="10">S = G&#x1D40; r, Var(S) = VR &#xB7; G&#x1D40; P G</text>

  <!-- All three merge -->
  <line x1="270" y1="620" x2="270" y2="660" stroke="#555" stroke-width="1.5"/>
  <line x1="850" y1="620" x2="850" y2="660" stroke="#555" stroke-width="1.5"/>
  <line x1="1380" y1="620" x2="1380" y2="660" stroke="#555" stroke-width="1.5"/>
  <line x1="270" y1="660" x2="1380" y2="660" stroke="#555" stroke-width="1.5"/>
  <line x1="850" y1="660" x2="850" y2="680" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- Compute Z -->
  <rect x="680" y="680" width="340" height="40" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="850" y="705" text-anchor="middle" font-size="12" fill="#333">Compute: Z = S / &#x221A;Var(S), p = 2&#x22C5;&#x3A6;(&#x2212;|Z|)</text>

  <line x1="850" y1="720" x2="850" y2="755" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- ======= DECISION POINT 3: ER check (BEFORE SPA) ======= -->
  <text x="850" y="750" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 2</text>

  <polygon points="850,765 1060,805 850,845 640,805" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="798" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Binary trait AND</text>
  <text x="850" y="812" text-anchor="middle" fill="white" font-size="10" font-weight="bold">MAC &#x2264; ER cutoff?</text>

  <!-- YES: ER path -->
  <line x1="1060" y1="805" x2="1350" y2="805" stroke="#d35400" stroke-width="2.5"/>
  <line x1="1350" y1="805" x2="1350" y2="850" stroke="#d35400" stroke-width="2.5" marker-end="url(#a2o)"/>
  <text x="1180" y="797" font-size="10" fill="#d35400" font-weight="bold">YES: ultra-rare binary</text>

  <rect x="1220" y="850" width="260" height="50" rx="6" fill="#d35400" stroke="#e67e22" stroke-width="2"/>
  <text x="1350" y="870" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Efficient Resampling (ER)</text>
  <text x="1350" y="890" text-anchor="middle" fill="#fde3cd" font-size="10">Exact/Monte Carlo p-value</text>

  <!-- NO: continue to SPA check -->
  <line x1="850" y1="845" x2="850" y2="880" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>
  <text x="810" y="870" font-size="10" fill="#555">NO</text>

  <!-- ======= DECISION POINT 2: SPA vs Normal ======= -->
  <text x="850" y="878" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 3</text>

  <polygon points="850,890 1070,930 850,970 630,930" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="925" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Binary AND |Z| &gt; SPA cutoff?</text>
  <text x="850" y="940" text-anchor="middle" fill="white" font-size="9">(not quantitative)</text>

  <!-- NO: Normal approximation -->
  <line x1="630" y1="930" x2="300" y2="930" stroke="#95a5a6" stroke-width="2"/>
  <line x1="300" y1="930" x2="300" y2="970" stroke="#95a5a6" stroke-width="2" marker-end="url(#a2)"/>
  <text x="450" y="922" font-size="10" fill="#95a5a6" font-weight="bold">NO (quant or small Z)</text>

  <rect x="170" y="970" width="260" height="45" rx="6" fill="#95a5a6" stroke="#7f8c8d"/>
  <text x="300" y="990" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Normal Approximation</text>
  <text x="300" y="1005" text-anchor="middle" fill="#ecf0f1" font-size="10">p = P(&#x3C7;&#xB2;&#x2081; &gt; Z&#xB2;) stands</text>

  <!-- YES: SPA -->
  <line x1="850" y1="970" x2="850" y2="1000" stroke="#e74c3c" stroke-width="2.5" marker-end="url(#a2r)"/>
  <text x="870" y="993" font-size="10" fill="#e74c3c" font-weight="bold">YES</text>

  <!-- SPA sub-decision: fast vs full -->
  <polygon points="850,1010 1020,1040 850,1070 680,1040" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="850" y="1037" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Nonzero frac &#x2265; 50%</text>
  <text x="850" y="1050" text-anchor="middle" fill="#333" font-size="9">AND not sparse?</text>

  <!-- Fast SPA -->
  <line x1="680" y1="1040" x2="530" y2="1040" stroke="#e74c3c" stroke-width="2"/>
  <line x1="530" y1="1040" x2="530" y2="1080" stroke="#e74c3c" stroke-width="2" marker-end="url(#a2r)"/>
  <text x="590" y="1032" font-size="9" fill="#e74c3c">YES</text>
  <rect x="420" y="1080" width="220" height="45" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="530" y="1100" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SPA Fast (NB/NA split)</text>
  <text x="530" y="1115" text-anchor="middle" fill="#f5c6cb" font-size="9">Approximate via sample partition</text>

  <!-- Full SPA -->
  <line x1="1020" y1="1040" x2="1130" y2="1040" stroke="#c0392b" stroke-width="2"/>
  <line x1="1130" y1="1040" x2="1130" y2="1080" stroke="#c0392b" stroke-width="2" marker-end="url(#a2r)"/>
  <text x="1070" y="1032" font-size="9" fill="#c0392b">NO</text>
  <rect x="1020" y="1080" width="220" height="45" rx="6" fill="#c0392b" stroke="#922b21"/>
  <text x="1130" y="1100" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SPA Full (all samples)</text>
  <text x="1130" y="1115" text-anchor="middle" fill="#f5c6cb" font-size="9">Newton-Raphson: K&#x2032;(&#x3B6;) = q</text>

  <!-- SPA convergence check -->
  <line x1="530" y1="1125" x2="530" y2="1155" stroke="#555" stroke-width="1.5"/>
  <line x1="1130" y1="1125" x2="1130" y2="1155" stroke="#555" stroke-width="1.5"/>
  <line x1="530" y1="1155" x2="1130" y2="1155" stroke="#555" stroke-width="1.5"/>
  <line x1="830" y1="1155" x2="830" y2="1180" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <polygon points="830,1185 970,1210 830,1235 690,1210" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="830" y="1213" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">SPA converged?</text>

  <line x1="690" y1="1210" x2="530" y2="1210" stroke="#95a5a6" stroke-width="2"/>
  <text x="600" y="1203" font-size="9" fill="#95a5a6">NO: fall back</text>
  <line x1="530" y1="1210" x2="300" y2="1015" stroke="#95a5a6" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#a2)"/>

  <line x1="830" y1="1235" x2="830" y2="1260" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>
  <text x="852" y="1252" font-size="9" fill="#27ae60">YES: use SPA p</text>

  <!-- ======= MERGE: All paths converge for Firth check ======= -->
  <!-- ER path also merges -->
  <line x1="1350" y1="900" x2="1350" y2="1260" stroke="#d35400" stroke-width="1.5"/>
  <line x1="1350" y1="1260" x2="830" y2="1260" stroke="#555" stroke-width="1.5"/>
  <line x1="300" y1="1015" x2="300" y2="1260" stroke="#95a5a6" stroke-width="1.5"/>
  <line x1="300" y1="1260" x2="830" y2="1260" stroke="#555" stroke-width="1"/>

  <!-- ======= DECISION POINT 4: Firth ======= -->
  <text x="830" y="1278" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 4</text>

  <polygon points="830,1285 1010,1315 830,1345 650,1315" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="830" y="1312" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Binary AND p &#x2264; p_Firth?</text>

  <!-- YES: Firth -->
  <line x1="1010" y1="1315" x2="1200" y2="1315" stroke="#e74c3c" stroke-width="2"/>
  <line x1="1200" y1="1315" x2="1200" y2="1348" stroke="#e74c3c" stroke-width="2" marker-end="url(#a2r)"/>
  <text x="1090" y="1307" font-size="10" fill="#e74c3c" font-weight="bold">YES</text>

  <rect x="1080" y="1348" width="240" height="45" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1200" y="1366" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Firth Correction</text>
  <text x="1200" y="1383" text-anchor="middle" fill="#f5c6cb" font-size="10">Penalized logistic regression for &#x3B2;&#x0302;</text>

  <!-- NO: no Firth -->
  <line x1="650" y1="1315" x2="530" y2="1315" stroke="#555" stroke-width="1.5"/>
  <text x="570" y="1307" font-size="10" fill="#555">NO</text>

  <!-- Both merge -->
  <line x1="530" y1="1315" x2="530" y2="1410" stroke="#555" stroke-width="1.5"/>
  <line x1="1200" y1="1393" x2="1200" y2="1410" stroke="#555" stroke-width="1.5"/>
  <line x1="530" y1="1410" x2="1200" y2="1410" stroke="#555" stroke-width="1"/>
  <line x1="830" y1="1410" x2="830" y2="1438" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- ======= DECISION POINT 5: Fast Test Re-evaluation ======= -->
  <text x="830" y="1436" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 5</text>

  <polygon points="830,1445 1040,1480 830,1515 620,1480" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="830" y="1475" text-anchor="middle" fill="white" font-size="10" font-weight="bold">isFastTest AND p &lt; 0.05?</text>
  <text x="830" y="1490" text-anchor="middle" fill="white" font-size="9">(and not ER-eligible)</text>

  <!-- YES: re-evaluate -->
  <line x1="1040" y1="1480" x2="1260" y2="1480" stroke="#27ae60" stroke-width="2"/>
  <line x1="1260" y1="1480" x2="1260" y2="1515" stroke="#27ae60" stroke-width="2" marker-end="url(#a2g)"/>
  <text x="1140" y="1472" font-size="10" fill="#27ae60" font-weight="bold">YES</text>

  <rect x="1100" y="1515" width="320" height="50" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="1260" y="1536" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Re-evaluate with full model</text>
  <text x="1260" y="1554" text-anchor="middle" fill="#c8f0d4" font-size="10">MAC > boundary: sparse=false; else: sparse=model</text>

  <!-- Re-eval feeds back to score test -->
  <line x1="1420" y1="1540" x2="1550" y2="1540" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="4,3"/>
  <line x1="1550" y1="1540" x2="1550" y2="500" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="4,3"/>
  <line x1="1550" y1="500" x2="1050" y2="500" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#a2g)"/>
  <text x="1570" y="1020" font-size="10" fill="#27ae60" transform="rotate(90,1570,1020)">loops back to score test</text>

  <!-- NO: keep result -->
  <line x1="830" y1="1515" x2="830" y2="1545" stroke="#555" stroke-width="1.5"/>
  <text x="790" y="1535" font-size="10" fill="#555">NO</text>

  <!-- Both merge to conditional check -->
  <line x1="830" y1="1545" x2="830" y2="1570" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- Conditional analysis decision -->
  <polygon points="830,1575 990,1600 830,1625 670,1600" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="830" y="1605" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Conditional markers?</text>

  <line x1="990" y1="1600" x2="1130" y2="1600" stroke="#16a085" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="1050" y="1593" font-size="9" fill="#16a085">YES</text>
  <rect x="1130" y="1585" width="200" height="30" rx="5" fill="#16a085" stroke="#1abc9c" stroke-dasharray="5,3"/>
  <text x="1230" y="1605" text-anchor="middle" fill="white" font-size="10">Compute &#x3B2;&#x0302;_c, SE_c, p_c</text>

  <line x1="830" y1="1625" x2="830" y2="1655" stroke="#555" stroke-width="2" marker-end="url(#a2)"/>

  <!-- Output -->
  <rect x="670" y="1655" width="320" height="36" rx="18" fill="#27ae60" stroke="#219a52" stroke-width="2"/>
  <text x="830" y="1678" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Output: CHR, POS, REF, ALT, AF, MAC, Beta, SE, p</text>
</svg>
</div>

<section id="sec-part2a">
<h3>2a. Score Test Selection</h3>
<div class="note">
<strong>Decision Point 1 &mdash; Score Test Path:</strong> The first branch selects among three score test implementations:
(1) <em>scoreTestFast_noadjCov</em> when no sparse GRM and no covariate adjustment,
(2) <em>scoreTest</em> (PCG solver) when sparse GRM is active,
(3) <em>scoreTestFast</em> (standard projection) as the default path.
If <code>isFastTest</code> is enabled, the initial call always uses <code>sparse=false</code>, deferring the full model until re-evaluation.
</div>
</section>

<section id="sec-part2b">
<h3>2b. SPA / ER / Normal Approximation</h3>
<div class="note">
<strong>Decision Points 2&ndash;3 &mdash; ER and SPA:</strong>
After computing the score statistic $Z$, binary traits take one of three paths:
(2) If MAC is below the ER cutoff, <em>Efficient Resampling</em> computes an exact or Monte Carlo p-value.
(3) If $|Z|$ exceeds the SPA cutoff (default 2), the <em>Saddlepoint Approximation</em> corrects for case-control imbalance using Newton-Raphson root-finding.
Otherwise, the normal approximation $p = P(\chi^2_1 > Z^2)$ is used directly.
SPA further branches into a <em>fast</em> path (when nonzero genotype fraction $\geq$ 50% and no sparse GRM) and a <em>full</em> path (all samples).
</div>
</section>

<section id="sec-part2c">
<h3>2c. Firth Correction &amp; Fast-Test Re-evaluation</h3>
<div class="note">
<strong>Decision Points 4&ndash;5 &mdash; Firth and Re-eval:</strong>
(4) For binary traits with $p \leq$ the Firth threshold, <em>penalized logistic regression</em> produces a bias-corrected $\hat{\beta}$.
(5) When <code>isFastTest</code> is enabled and $p < 0.05$, the marker is re-evaluated using the full model (either sparse or standard, depending on the MAC boundary), then the entire SPA/ER/Firth logic runs again on the refined estimate.
Finally, if conditional markers are specified, conditional $\hat{\beta}_c$, $SE_c$, and $p_c$ are computed.
</div>
</section>

</section>


<!-- ============================================================ -->
<!-- PART 3: REGION/GENE PATH -->
<!-- ============================================================ -->
<section id="sec-part3">
<h2>Part 3: Region / Gene-Based Testing</h2>

<p>For each gene, markers are collected, classified as regular or ultra-rare, and then BURDEN/SKAT/SKAT-O tests are applied.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1700 1500" width="1680" height="1490" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1700" height="1500" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a3r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a3b" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#3498db"/></marker>
    <marker id="a3g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
    <marker id="a3o" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e67e22"/></marker>
    <marker id="a3p" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#8e44ad"/></marker>
  </defs>

  <!-- Title -->
  <text x="850" y="28" text-anchor="middle" font-size="18" font-weight="bold" fill="#2c3e50">Region / Gene-Based Testing &mdash; Complete Flow</text>

  <!-- START -->
  <rect x="680" y="48" width="340" height="40" rx="20" fill="#8e44ad" stroke="#7d3c98" stroke-width="2"/>
  <text x="850" y="73" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Parse group file: gene &rarr; variants + annotations</text>

  <line x1="850" y1="88" x2="850" y2="115" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- For each gene loop -->
  <rect x="700" y="115" width="300" height="36" rx="6" fill="#34495e" stroke="#2c3e50"/>
  <text x="850" y="138" text-anchor="middle" fill="white" font-size="12" font-weight="bold">For each gene, annotation mask, MAF cutoff:</text>

  <line x1="850" y1="151" x2="850" y2="178" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- Read markers for region -->
  <rect x="700" y="178" width="300" height="36" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="850" y="200" text-anchor="middle" font-size="11" fill="#333">Read all markers for this region, apply QC filters</text>

  <line x1="850" y1="214" x2="850" y2="248" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- Weight assignment -->
  <polygon points="850,248 1020,280 850,312 680,280" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="850" y="276" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Custom weights?</text>

  <line x1="680" y1="280" x2="520" y2="280" stroke="#555" stroke-width="1.5"/>
  <text x="580" y="273" font-size="9" fill="#555">NO</text>
  <rect x="380" y="265" width="140" height="30" rx="5" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="450" y="284" text-anchor="middle" font-size="10" fill="#333">w&#x2080; = Beta(MAF; 1, 25)</text>

  <line x1="1020" y1="280" x2="1160" y2="280" stroke="#555" stroke-width="1.5"/>
  <text x="1080" y="273" font-size="9" fill="#555">YES</text>
  <rect x="1160" y="265" width="160" height="30" rx="5" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="1240" y="284" text-anchor="middle" font-size="10" fill="#333">Use group file weight</text>

  <!-- Merge -->
  <line x1="450" y1="295" x2="450" y2="330" stroke="#555" stroke-width="1"/>
  <line x1="1240" y1="295" x2="1240" y2="330" stroke="#555" stroke-width="1"/>
  <line x1="450" y1="330" x2="1240" y2="330" stroke="#555" stroke-width="1"/>
  <line x1="850" y1="330" x2="850" y2="355" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- ======= DECISION POINT 6: URV vs Regular ======= -->
  <text x="850" y="350" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 6</text>

  <polygon points="850,365 1050,400 850,435 650,400" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="398" text-anchor="middle" fill="white" font-size="11" font-weight="bold">MAC > minMAC cutoff (10)?</text>

  <!-- YES: Regular marker -->
  <line x1="650" y1="400" x2="340" y2="400" stroke="#27ae60" stroke-width="2"/>
  <line x1="340" y1="400" x2="340" y2="445" stroke="#27ae60" stroke-width="2" marker-end="url(#a3g)"/>
  <text x="470" y="392" font-size="10" fill="#27ae60" font-weight="bold">YES: regular marker</text>

  <rect x="200" y="445" width="280" height="50" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="340" y="466" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Individual Score Test</text>
  <text x="340" y="484" text-anchor="middle" fill="#c8f0d4" font-size="10">Add to P&#x2081; and P&#x2082; matrices (row per marker)</text>

  <!-- Run single-variant test for this marker -->
  <line x1="340" y1="495" x2="340" y2="520" stroke="#555" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="200" y="520" width="280" height="36" rx="5" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="340" y="543" text-anchor="middle" font-size="10" fill="#333">Single-variant p-value (same as Part 2 flow)</text>

  <!-- NO: URV collapse -->
  <line x1="1050" y1="400" x2="1350" y2="400" stroke="#e67e22" stroke-width="2"/>
  <line x1="1350" y1="400" x2="1350" y2="445" stroke="#e67e22" stroke-width="2" marker-end="url(#a3o)"/>
  <text x="1190" y="392" font-size="10" fill="#e67e22" font-weight="bold">NO: ultra-rare variant (URV)</text>

  <rect x="1200" y="445" width="300" height="50" rx="6" fill="#e67e22" stroke="#d35400"/>
  <text x="1350" y="466" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Collapse via max()</text>
  <text x="1350" y="484" text-anchor="middle" fill="#fde3cd" font-size="10">Per annotation &#xD7; MAF: G_URV(i) = max_j G_j(i)</text>

  <line x1="1350" y1="495" x2="1350" y2="525" stroke="#555" stroke-width="1.5" marker-end="url(#a3)"/>
  <rect x="1210" y="525" width="280" height="36" rx="5" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="1350" y="548" text-anchor="middle" font-size="10" fill="#333">Score URV pseudo-marker, add to P&#x2081;/P&#x2082;</text>

  <!-- Merge URV and regular paths -->
  <line x1="340" y1="556" x2="340" y2="600" stroke="#555" stroke-width="1.5"/>
  <line x1="1350" y1="561" x2="1350" y2="600" stroke="#555" stroke-width="1.5"/>
  <line x1="340" y1="600" x2="1350" y2="600" stroke="#555" stroke-width="1.5"/>
  <line x1="850" y1="600" x2="850" y2="628" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- Build covariance -->
  <rect x="620" y="628" width="460" height="55" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="850" y="650" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Build Variance-Covariance Matrix</text>
  <text x="850" y="670" text-anchor="middle" fill="#d5e8f7" font-size="10">&#x3A3; = P&#x2081;&#xB7;P&#x2082; where P&#x2081; = &#x221A;VR &#xB7; G_adj&#x1D40;, P&#x2082; = &#x221A;VR &#xB7; &#x3A3;&#x207B;&#xB9;_null &#xB7; G</text>

  <line x1="850" y1="683" x2="850" y2="715" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- ======= DECISION POINT 7: Test type dispatch ======= -->
  <text x="850" y="712" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 7</text>

  <polygon points="850,725 1060,760 850,795 640,760" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="850" y="758" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Test type?</text>

  <!-- BURDEN (left) -->
  <line x1="640" y1="760" x2="300" y2="760" stroke="#2ecc71" stroke-width="2.5"/>
  <line x1="300" y1="760" x2="300" y2="800" stroke="#2ecc71" stroke-width="2.5" marker-end="url(#a3g)"/>
  <text x="440" y="752" font-size="10" fill="#2ecc71" font-weight="bold">BURDEN (&#x3C1; = 1)</text>

  <rect x="150" y="800" width="300" height="60" rx="6" fill="#2ecc71" stroke="#27ae60"/>
  <text x="300" y="822" text-anchor="middle" fill="white" font-size="12" font-weight="bold">BURDEN Test</text>
  <text x="300" y="842" text-anchor="middle" fill="#c8f0d4" font-size="10">T = (&#x2211;&#x1D62; w&#x1D62; S&#x1D62;)&#xB2; / w&#x1D40; &#x3A3; w</text>
  <text x="300" y="855" text-anchor="middle" fill="#c8f0d4" font-size="9">p = P(&#x3C7;&#xB2;&#x2081; &gt; T)</text>

  <!-- SKAT (center-right) -->
  <line x1="850" y1="795" x2="850" y2="800" stroke="#3498db" stroke-width="2.5" marker-end="url(#a3b)"/>

  <rect x="700" y="800" width="300" height="60" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="850" y="822" text-anchor="middle" fill="white" font-size="12" font-weight="bold">SKAT Test</text>
  <text x="850" y="842" text-anchor="middle" fill="#d5e8f7" font-size="10">Q = S&#x1D40; W S, p via Davies/Liu</text>

  <!-- SKAT-O (right) -->
  <line x1="1060" y1="760" x2="1400" y2="760" stroke="#9b59b6" stroke-width="2.5"/>
  <line x1="1400" y1="760" x2="1400" y2="800" stroke="#9b59b6" stroke-width="2.5" marker-end="url(#a3p)"/>
  <text x="1210" y="752" font-size="10" fill="#9b59b6" font-weight="bold">SKAT-O (&#x3C1; grid: 0 to 1)</text>

  <rect x="1250" y="800" width="300" height="60" rx="6" fill="#9b59b6" stroke="#8e44ad"/>
  <text x="1400" y="822" text-anchor="middle" fill="white" font-size="12" font-weight="bold">SKAT-O (optimal &#x3C1;)</text>
  <text x="1400" y="842" text-anchor="middle" fill="#dcc6e8" font-size="10">Grid search: &#x3C1; &#x2208; {0, 0.01, ..., 1}</text>
  <text x="1400" y="855" text-anchor="middle" fill="#dcc6e8" font-size="9">SKAT (&#x3C1;=0) &#x2194; BURDEN (&#x3C1;=1)</text>

  <!-- Davies/Liu sub-decision for SKAT -->
  <line x1="850" y1="860" x2="850" y2="895" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <text x="850" y="893" text-anchor="middle" font-size="10" fill="#e74c3c" font-weight="bold">Decision Point 8</text>

  <polygon points="850,905 1030,935 850,965 670,935" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="850" y="932" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Davies converges?</text>
  <text x="850" y="945" text-anchor="middle" fill="#333" font-size="9">(ifault=0, p &#x2208; [0,1], finite)</text>

  <!-- YES: Davies -->
  <line x1="670" y1="935" x2="530" y2="935" stroke="#27ae60" stroke-width="2"/>
  <line x1="530" y1="935" x2="530" y2="968" stroke="#27ae60" stroke-width="2" marker-end="url(#a3g)"/>
  <text x="586" y="927" font-size="9" fill="#27ae60" font-weight="bold">YES</text>
  <rect x="410" y="968" width="240" height="36" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="530" y="991" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Davies p-value (exact)</text>

  <!-- NO: Liu fallback -->
  <line x1="1030" y1="935" x2="1160" y2="935" stroke="#e67e22" stroke-width="2"/>
  <line x1="1160" y1="935" x2="1160" y2="968" stroke="#e67e22" stroke-width="2" marker-end="url(#a3o)"/>
  <text x="1085" y="927" font-size="9" fill="#e67e22" font-weight="bold">NO</text>
  <rect x="1030" y="968" width="260" height="36" rx="6" fill="#e67e22" stroke="#d35400"/>
  <text x="1160" y="985" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Liu moment-matching fallback</text>
  <text x="1160" y="997" text-anchor="middle" fill="#fde3cd" font-size="9">Noncentral or central &#x3C7;&#xB2; approximation</text>

  <!-- SKAT-O also uses Davies/Liu -->
  <line x1="1400" y1="860" x2="1400" y2="935" stroke="#555" stroke-width="1.5"/>
  <line x1="1400" y1="935" x2="1290" y2="935" stroke="#555" stroke-width="1" stroke-dasharray="4,3"/>
  <text x="1340" y="927" font-size="8" fill="#555">also uses Davies/Liu per &#x3C1;</text>

  <!-- All merge after test -->
  <line x1="300" y1="860" x2="300" y2="1040" stroke="#555" stroke-width="1.5"/>
  <line x1="530" y1="1004" x2="530" y2="1040" stroke="#555" stroke-width="1.5"/>
  <line x1="1160" y1="1004" x2="1160" y2="1040" stroke="#555" stroke-width="1.5"/>
  <line x1="300" y1="1040" x2="1160" y2="1040" stroke="#555" stroke-width="1.5"/>
  <line x1="850" y1="1040" x2="850" y2="1068" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- Binary SPA Phi adjustment -->
  <polygon points="850,1075 1040,1105 850,1135 660,1105" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="850" y="1102" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Binary or survival trait?</text>

  <!-- YES: SPA Phi adjustment -->
  <line x1="1040" y1="1105" x2="1240" y2="1105" stroke="#e74c3c" stroke-width="2"/>
  <line x1="1240" y1="1105" x2="1240" y2="1140" stroke="#e74c3c" stroke-width="2" marker-end="url(#a3r)"/>
  <text x="1130" y="1097" font-size="10" fill="#e74c3c" font-weight="bold">YES</text>

  <rect x="1080" y="1140" width="320" height="50" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1240" y="1160" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SPA &#x3A6; Adjustment</text>
  <text x="1240" y="1178" text-anchor="middle" fill="#f5c6cb" font-size="10">Scale &#x3A3;&#x1D62;&#x2C7C; using p_SPA / p_norm ratio per variant</text>

  <!-- NO -->
  <line x1="660" y1="1105" x2="530" y2="1105" stroke="#555" stroke-width="1.5"/>
  <text x="580" y="1097" font-size="9" fill="#555">NO: use &#x3A3; as-is</text>

  <!-- Merge -->
  <line x1="530" y1="1105" x2="530" y2="1210" stroke="#555" stroke-width="1.5"/>
  <line x1="1240" y1="1190" x2="1240" y2="1210" stroke="#555" stroke-width="1.5"/>
  <line x1="530" y1="1210" x2="1240" y2="1210" stroke="#555" stroke-width="1"/>
  <line x1="850" y1="1210" x2="850" y2="1240" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- CCT decision -->
  <polygon points="850,1247 1060,1277 850,1307 640,1277" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="850" y="1272" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Multiple annotations</text>
  <text x="850" y="1285" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">or MAF cutoffs?</text>

  <!-- YES: CCT -->
  <line x1="1060" y1="1277" x2="1240" y2="1277" stroke="#e67e22" stroke-width="2"/>
  <line x1="1240" y1="1277" x2="1240" y2="1320" stroke="#e67e22" stroke-width="2" marker-end="url(#a3o)"/>
  <text x="1140" y="1269" font-size="10" fill="#e67e22" font-weight="bold">YES</text>

  <rect x="1100" y="1320" width="280" height="50" rx="6" fill="#e67e22" stroke="#d35400"/>
  <text x="1240" y="1340" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Cauchy Combination Test</text>
  <text x="1240" y="1358" text-anchor="middle" fill="#fde3cd" font-size="10">T_CCT = &#x2211;&#x2096; w&#x2096; tan((&#xBD; &#x2212; p&#x2096;)&#x3C0;)</text>

  <!-- NO: single group -->
  <line x1="640" y1="1277" x2="530" y2="1277" stroke="#555" stroke-width="1.5"/>
  <text x="575" y="1270" font-size="9" fill="#555">NO: single group</text>

  <!-- Merge to output -->
  <line x1="530" y1="1277" x2="530" y2="1400" stroke="#555" stroke-width="1.5"/>
  <line x1="1240" y1="1370" x2="1240" y2="1400" stroke="#555" stroke-width="1.5"/>
  <line x1="530" y1="1400" x2="1240" y2="1400" stroke="#555" stroke-width="1"/>
  <line x1="850" y1="1400" x2="850" y2="1430" stroke="#555" stroke-width="2" marker-end="url(#a3)"/>

  <!-- Output -->
  <rect x="580" y="1430" width="540" height="40" rx="20" fill="#27ae60" stroke="#219a52" stroke-width="2"/>
  <text x="850" y="1455" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Output: Region, Annotation, MAF, p_SKATO, p_Burden, p_SKAT, CCT p</text>
</svg>
</div>

<section id="sec-part3a">
<h3>3a. Marker Classification</h3>
<div class="note">
<strong>Decision Point 6 &mdash; Regular vs Ultra-Rare:</strong> Each variant in the region is classified by its MAC.
Variants with MAC above the <code>minMAC</code> cutoff (default 10) are treated as <em>regular markers</em> and scored individually.
Variants below the cutoff are <em>ultra-rare</em> and collapsed per annotation/MAF group using <code>max()</code> to form a single pseudo-marker.
Weights are assigned via Beta(MAF; 1, 25) by default, or from the group file if custom weights are provided.
</div>
</section>

<section id="sec-part3b">
<h3>3b. BURDEN / SKAT / SKAT-O</h3>
<div class="note">
<strong>Decision Point 7 &mdash; Test Type:</strong> After building the variance-covariance matrix
$\Sigma = P_1 \cdot P_2$, three tests are computed:
<em>BURDEN</em> ($\rho=1$): $T = (\sum_i w_i S_i)^2 / w^\top \Sigma w$, tested as $\chi^2_1$.
<em>SKAT</em> ($\rho=0$): $Q = S^\top W S$, p-value via Davies method (exact) or Liu moment-matching (fallback).
<em>SKAT-O</em>: grid search over $\rho \in \{0, 0.01, \ldots, 1\}$, combining SKAT and BURDEN optimally.
For binary traits, the SPA $\Phi$ adjustment scales $\Sigma_{ij}$ using per-variant $p_{SPA}/p_{norm}$ ratios.
</div>
</section>

<section id="sec-part3c">
<h3>3c. Davies vs Liu</h3>
<div class="note">
<strong>Decision Point 8 &mdash; P-value Method:</strong> The SKAT quadratic form $Q \sim \sum \lambda_j \chi^2_1$
is evaluated by the <em>Davies method</em> (numerical inversion of the characteristic function).
If Davies fails (<code>ifault != 0</code>, $p \notin [0,1]$, or non-finite), the <em>Liu moment-matching</em>
fallback approximates the distribution with a noncentral or central $\chi^2$.
SKAT-O applies the same logic at each $\rho$ value in the grid.
The Liu approximation is typically accurate to within a few percent but can diverge for extreme tail probabilities.
</div>
</section>

</section>


<!-- ============================================================ -->
<!-- PART 4: SPA DETAIL -->
<!-- ============================================================ -->
<section id="sec-part4">
<h2>Part 4: SPA (Saddlepoint Approximation) Detail</h2>

<p>SPA corrects the score test p-value for binary traits with case-control imbalance. The core is Newton-Raphson root-finding followed by saddle probability computation.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1400 680" width="1380" height="670" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1400" height="680" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a4r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a4g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
  </defs>

  <text x="700" y="28" text-anchor="middle" font-size="16" font-weight="bold" fill="#2c3e50">SPA: Saddlepoint Approximation for Binary Traits</text>

  <!-- Entry -->
  <rect x="550" y="50" width="300" height="36" rx="18" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
  <text x="700" y="73" text-anchor="middle" fill="white" font-size="12" font-weight="bold">SPA called for binary trait with |Z| &gt; cutoff</text>

  <line x1="700" y1="86" x2="700" y2="115" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>

  <!-- Compute q -->
  <rect x="530" y="115" width="340" height="36" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="700" y="138" text-anchor="middle" font-size="11" fill="#333">Compute q = T/&#x221A;(Var&#x2081;/Var&#x2082;) + &#x2211; &#x3BC;&#x1D62; g&#x1D62; (test statistic on original scale)</text>

  <line x1="700" y1="151" x2="700" y2="185" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>

  <!-- Boundary check -->
  <polygon points="700,185 870,215 700,245 530,215" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="700" y="213" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">q &#x2265; &#x2211; g&#x1D62;&#x207A; or q &#x2264; &#x2211; g&#x1D62;&#x207B;?</text>

  <!-- YES: boundary -->
  <line x1="870" y1="215" x2="1050" y2="215" stroke="#e74c3c" stroke-width="2"/>
  <rect x="1050" y="200" width="220" height="30" rx="5" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1160" y="220" text-anchor="middle" fill="white" font-size="10" font-weight="bold">&#x3B6; = &#x221E;, converged (boundary)</text>

  <!-- NO: Newton-Raphson -->
  <line x1="700" y1="245" x2="700" y2="280" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>
  <text x="720" y="268" font-size="9" fill="#555">NO</text>

  <!-- Newton-Raphson iteration box -->
  <rect x="490" y="280" width="420" height="60" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="700" y="300" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Newton-Raphson: find &#x3B6; such that K&#x2032;(&#x3B6;) = q</text>
  <text x="700" y="320" text-anchor="middle" fill="#d5e8f7" font-size="10">K(t) = &#x2211;&#x1D62; log(1 &#x2212; &#x3BC;&#x1D62; + &#x3BC;&#x1D62; exp(g&#x1D62; t)), update &#x3B6; &#x2190; &#x3B6; &#x2212; (K&#x2032;(&#x3B6;) &#x2212; q)/K&#x2033;(&#x3B6;)</text>
  <text x="700" y="335" text-anchor="middle" fill="#d5e8f7" font-size="9">Anti-overshoot: bisect if sign of K&#x2032; flips</text>

  <line x1="700" y1="340" x2="700" y2="370" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>

  <!-- Convergence -->
  <polygon points="700,375 850,405 700,435 550,405" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="700" y="403" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Converged (|&#x394;&#x3B6;| &lt; tol)?</text>

  <!-- NO: failed -->
  <line x1="550" y1="405" x2="300" y2="405" stroke="#95a5a6" stroke-width="2"/>
  <text x="410" y="397" font-size="10" fill="#95a5a6" font-weight="bold">NO</text>
  <rect x="170" y="390" width="130" height="30" rx="5" fill="#95a5a6" stroke="#7f8c8d"/>
  <text x="235" y="410" text-anchor="middle" fill="white" font-size="10">SPA not converged</text>
  <line x1="235" y1="420" x2="235" y2="460" stroke="#95a5a6" stroke-width="1.5" marker-end="url(#a4)"/>
  <rect x="150" y="460" width="170" height="30" rx="5" fill="#95a5a6" stroke="#7f8c8d"/>
  <text x="235" y="480" text-anchor="middle" fill="white" font-size="10">Fall back to normal p</text>

  <!-- YES: saddle probability -->
  <line x1="700" y1="435" x2="700" y2="468" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>
  <text x="720" y="455" font-size="9" fill="#27ae60">YES</text>

  <rect x="480" y="468" width="440" height="55" rx="6" fill="#34495e" stroke="#2c3e50"/>
  <text x="700" y="488" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Saddle Probability</text>
  <text x="700" y="508" text-anchor="middle" fill="#b0bec5" font-size="10">w = sgn(&#x3B6;)&#x221A;(2(&#x3B6;q &#x2212; K(&#x3B6;))), v = &#x3B6;&#x221A;(K&#x2033;(&#x3B6;))</text>

  <line x1="700" y1="523" x2="700" y2="555" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>

  <!-- Two-sided p-value -->
  <rect x="480" y="555" width="440" height="50" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="700" y="575" text-anchor="middle" font-size="11" fill="#333" font-weight="bold">Two-sided p-value</text>
  <text x="700" y="593" text-anchor="middle" font-size="10" fill="#555">p = p_upper(q) + p_lower(q*) where q* = 2&#x2211;&#x3BC;&#x1D62;g&#x1D62; &#x2212; q</text>

  <line x1="700" y1="605" x2="700" y2="635" stroke="#555" stroke-width="2" marker-end="url(#a4)"/>

  <!-- Return -->
  <rect x="570" y="635" width="260" height="35" rx="17" fill="#27ae60" stroke="#219a52" stroke-width="2"/>
  <text x="700" y="657" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Return SPA-corrected p</text>

  <!-- ER side path also goes back -->
  <line x1="1160" y1="230" x2="1160" y2="635" stroke="#d35400" stroke-width="1.5" stroke-dasharray="5,3"/>
  <line x1="1160" y1="635" x2="830" y2="635" stroke="#d35400" stroke-width="1" stroke-dasharray="5,3"/>
  <text x="1185" y="430" font-size="9" fill="#d35400" transform="rotate(90,1185,430)">boundary: skip N-R</text>
</svg>
</div>

</section>


<!-- ============================================================ -->
<!-- PART 5: VR ASSIGNMENT -->
<!-- ============================================================ -->
<section id="sec-part5">
<h2>Part 5: Variance Ratio Assignment Logic</h2>

<p>The variance ratio (VR) adjusts the score test variance for computational shortcuts. Different VR values are used depending on the MAC bin, sparse GRM status, and covariate adjustment mode.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1300 520" width="1280" height="510" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1300" height="520" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a5" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a5r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a5g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
  </defs>

  <text x="650" y="28" text-anchor="middle" font-size="16" font-weight="bold" fill="#2c3e50">Variance Ratio Assignment</text>

  <!-- Entry -->
  <rect x="500" y="50" width="300" height="36" rx="18" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
  <text x="650" y="73" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Compute MAC for current marker</text>

  <line x1="650" y1="86" x2="650" y2="120" stroke="#555" stroke-width="2" marker-end="url(#a5)"/>

  <!-- Single vs categorical -->
  <polygon points="650,120 840,155 650,190 460,155" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="650" y="153" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Single VR category?</text>

  <!-- YES: single -->
  <line x1="460" y1="155" x2="200" y2="155" stroke="#27ae60" stroke-width="2"/>
  <line x1="200" y1="155" x2="200" y2="200" stroke="#27ae60" stroke-width="2" marker-end="url(#a5g)"/>
  <text x="300" y="147" font-size="10" fill="#27ae60" font-weight="bold">YES (1 category)</text>

  <rect x="80" y="200" width="240" height="36" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="200" y="223" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Use single VR directly for all MAC</text>

  <!-- NO: categorical -->
  <line x1="650" y1="190" x2="650" y2="230" stroke="#555" stroke-width="2" marker-end="url(#a5)"/>
  <text x="670" y="215" font-size="10" fill="#555">NO (multiple categories)</text>

  <!-- MAC bin match -->
  <rect x="470" y="230" width="360" height="40" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="650" y="254" text-anchor="middle" font-size="11" fill="#333">Find MAC bin: minMAC&#x1D62; &#x2264; MAC &lt; minMAC&#x1D62;&#x208A;&#x2081;</text>

  <line x1="650" y1="270" x2="650" y2="305" stroke="#555" stroke-width="2" marker-end="url(#a5)"/>

  <!-- 3-way VR type -->
  <polygon points="650,305 860,340 650,375 440,340" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
  <text x="650" y="338" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Which VR type?</text>

  <!-- Sparse GRM path -->
  <line x1="860" y1="340" x2="1100" y2="340" stroke="#e74c3c" stroke-width="2"/>
  <line x1="1100" y1="340" x2="1100" y2="385" stroke="#e74c3c" stroke-width="2" marker-end="url(#a5r)"/>
  <text x="960" y="332" font-size="10" fill="#e74c3c" font-weight="bold">sparse GRM active</text>
  <rect x="980" y="385" width="240" height="45" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1100" y="405" text-anchor="middle" fill="white" font-size="11" font-weight="bold">VR_sparse[i]</text>
  <text x="1100" y="422" text-anchor="middle" fill="#f5c6cb" font-size="9">PCG score test path</text>

  <!-- noadjCov path -->
  <line x1="440" y1="340" x2="200" y2="340" stroke="#16a085" stroke-width="2"/>
  <line x1="200" y1="340" x2="200" y2="385" stroke="#16a085" stroke-width="2" marker-end="url(#a5)"/>
  <text x="290" y="332" font-size="10" fill="#16a085" font-weight="bold">noadjCov mode</text>
  <rect x="80" y="385" width="240" height="45" rx="6" fill="#16a085" stroke="#1abc9c"/>
  <text x="200" y="405" text-anchor="middle" fill="white" font-size="11" font-weight="bold">VR_noadjCov[i]</text>
  <text x="200" y="422" text-anchor="middle" fill="#a3e4d7" font-size="9">No covariate adjustment path</text>

  <!-- Standard path -->
  <line x1="650" y1="375" x2="650" y2="385" stroke="#3498db" stroke-width="2" marker-end="url(#a5)"/>
  <text x="670" y="380" font-size="10" fill="#3498db" font-weight="bold">default</text>
  <rect x="530" y="385" width="240" height="45" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="650" y="405" text-anchor="middle" fill="white" font-size="11" font-weight="bold">VR_null[i]</text>
  <text x="650" y="422" text-anchor="middle" fill="#d5e8f7" font-size="9">Standard fast score test path</text>

  <!-- All merge to output -->
  <line x1="200" y1="430" x2="200" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="650" y1="430" x2="650" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="1100" y1="430" x2="1100" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="200" y1="470" x2="1100" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="650" y1="470" x2="650" y2="495" stroke="#555" stroke-width="2" marker-end="url(#a5)"/>

  <rect x="480" y="495" width="340" height="30" rx="6" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="650" y="514" text-anchor="middle" font-size="11" fill="#333">Var(S) = VR &#xB7; G&#x1D40; P G used in score test</text>
</svg>
</div>

</section>


<!-- ============================================================ -->
<!-- PART 6: CCT -->
<!-- ============================================================ -->
<section id="sec-part6">
<h2>Part 6: Cauchy Combination Test (CCT)</h2>

<p>CCT combines p-values from multiple annotation masks or MAF cutoffs into a single gene-level p-value using the Cauchy distribution.</p>

<div class="pipeline-container">
<svg viewBox="0 0 1200 600" width="1180" height="590" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, sans-serif">
  <rect width="1200" height="600" fill="#fafbfc" rx="10"/>
  <defs>
    <marker id="a6" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#555"/></marker>
    <marker id="a6r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#e74c3c"/></marker>
    <marker id="a6g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#27ae60"/></marker>
  </defs>

  <text x="600" y="28" text-anchor="middle" font-size="16" font-weight="bold" fill="#2c3e50">Cauchy Combination Test (CCT)</text>

  <!-- Entry -->
  <rect x="400" y="50" width="400" height="36" rx="18" fill="#e67e22" stroke="#d35400" stroke-width="2"/>
  <text x="600" y="73" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Input: p&#x2081;, p&#x2082;, &#x2026;, p&#x2096; from multiple masks</text>

  <line x1="600" y1="86" x2="600" y2="120" stroke="#555" stroke-width="2" marker-end="url(#a6)"/>

  <!-- Any p = 0? -->
  <polygon points="600,120 770,150 600,180 430,150" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="600" y="153" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Any p&#x2096; = 0?</text>

  <line x1="770" y1="150" x2="950" y2="150" stroke="#e74c3c" stroke-width="2"/>
  <text x="850" y="142" font-size="10" fill="#e74c3c">YES</text>
  <rect x="950" y="135" width="170" height="30" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1035" y="155" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Return p_CCT = 0</text>

  <line x1="600" y1="180" x2="600" y2="215" stroke="#555" stroke-width="2" marker-end="url(#a6)"/>
  <text x="620" y="200" font-size="9" fill="#555">NO</text>

  <!-- Any p = 1? (all 1s edge case) -->
  <polygon points="600,215 780,245 600,275 420,245" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="600" y="248" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">Any p&#x2096; = 1? (degenerate)</text>

  <line x1="780" y1="245" x2="950" y2="245" stroke="#e67e22" stroke-width="2"/>
  <text x="860" y="237" font-size="10" fill="#e67e22">YES</text>
  <rect x="950" y="230" width="200" height="30" rx="6" fill="#e67e22" stroke="#d35400"/>
  <text x="1050" y="250" text-anchor="middle" fill="white" font-size="10">p_CCT = min(1, p_min &#xB7; k)</text>

  <line x1="600" y1="275" x2="600" y2="310" stroke="#555" stroke-width="2" marker-end="url(#a6)"/>
  <text x="620" y="295" font-size="9" fill="#555">NO</text>

  <!-- Compute Cauchy statistic -->
  <polygon points="600,315 810,350 600,385 390,350" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="600" y="348" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">All p&#x2096; &#x2265; 10&#x207B;&#xB9;&#x2076;? (no extreme values)</text>

  <!-- YES: standard formula -->
  <line x1="390" y1="350" x2="180" y2="350" stroke="#3498db" stroke-width="2"/>
  <line x1="180" y1="350" x2="180" y2="395" stroke="#3498db" stroke-width="2" marker-end="url(#a6)"/>
  <text x="270" y="342" font-size="10" fill="#3498db" font-weight="bold">YES</text>

  <rect x="40" y="395" width="280" height="40" rx="6" fill="#3498db" stroke="#2980b9"/>
  <text x="180" y="420" text-anchor="middle" fill="white" font-size="11" font-weight="bold">T = &#x2211;&#x2096; w&#x2096; tan((&#xBD; &#x2212; p&#x2096;)&#x3C0;)</text>

  <!-- NO: mixed formula for extreme p -->
  <line x1="810" y1="350" x2="1000" y2="350" stroke="#8e44ad" stroke-width="2"/>
  <line x1="1000" y1="350" x2="1000" y2="395" stroke="#8e44ad" stroke-width="2" marker-end="url(#a6)"/>
  <text x="900" y="342" font-size="10" fill="#8e44ad" font-weight="bold">NO (some extreme)</text>

  <rect x="860" y="395" width="280" height="40" rx="6" fill="#8e44ad" stroke="#7d3c98"/>
  <text x="1000" y="413" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Small: w&#x2096; / (p&#x2096; &#xB7; &#x3C0;)</text>
  <text x="1000" y="427" text-anchor="middle" fill="#dcc6e8" font-size="9">Large: tan((&#xBD; &#x2212; p&#x2096;)&#x3C0;)</text>

  <!-- Merge -->
  <line x1="180" y1="435" x2="180" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="1000" y1="435" x2="1000" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="180" y1="470" x2="1000" y2="470" stroke="#555" stroke-width="1"/>
  <line x1="600" y1="470" x2="600" y2="500" stroke="#555" stroke-width="2" marker-end="url(#a6)"/>

  <!-- Final: tail approx or CDF -->
  <polygon points="600,505 770,535 600,565 430,535" fill="#ffeaa7" stroke="#f39c12" stroke-width="1.5"/>
  <text x="600" y="538" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">T &gt; 10&#xB9;&#x2075;?</text>

  <line x1="430" y1="535" x2="220" y2="535" stroke="#555" stroke-width="1.5"/>
  <text x="310" y="527" font-size="9" fill="#555">NO</text>
  <rect x="100" y="520" width="120" height="30" rx="6" fill="#27ae60" stroke="#219a52"/>
  <text x="160" y="540" text-anchor="middle" fill="white" font-size="10">1 &#x2212; F_C(T)</text>

  <line x1="770" y1="535" x2="950" y2="535" stroke="#555" stroke-width="1.5"/>
  <text x="850" y="527" font-size="9" fill="#e74c3c">YES (extreme)</text>
  <rect x="950" y="520" width="160" height="30" rx="6" fill="#e74c3c" stroke="#c0392b"/>
  <text x="1030" y="540" text-anchor="middle" fill="white" font-size="10">1/(T&#xB7;&#x3C0;) (tail approx)</text>
</svg>
</div>

<div class="note">
<strong>$F_C$ is the Cauchy CDF:</strong> $F_C(x) = \frac{1}{2} + \frac{1}{\pi}\arctan(x)$. For very large $T$ the tail approximation $\frac{1}{T\pi}$ avoids numerical overflow.
</div>

</section>


</div><!-- #content -->

<script>
// Scroll-spy: highlight the active sidebar link based on scroll position
(function() {
  var links = document.querySelectorAll('#sidebar nav a');
  var sections = [];

  // Build ordered list of sections referenced by sidebar links
  links.forEach(function(link) {
    var id = link.getAttribute('href').replace('#', '');
    var el = document.getElementById(id);
    if (el) sections.push({ id: id, el: el, link: link });
  });

  function onScroll() {
    var scrollY = window.scrollY + 80; // offset for better alignment
    var current = null;

    // Find the last section whose top is above the scroll position
    for (var i = 0; i < sections.length; i++) {
      if (sections[i].el.getBoundingClientRect().top + window.scrollY <= scrollY) {
        current = sections[i];
      }
    }

    links.forEach(function(link) { link.classList.remove('active'); });
    if (current) current.link.classList.add('active');
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  // Run once on load
  onScroll();
})();
</script>
</body>
</html>
